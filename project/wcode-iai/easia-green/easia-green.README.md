# üìÑ Passport Reader API - EASIA GREEN

H·ªá th·ªëng tr√≠ch xu·∫•t th√¥ng tin t·ª´ h·ªô chi·∫øu (passport) t·ª´ ·∫£nh v√† PDF, tr·∫£ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng JSON. API c√≥ th·ªÉ ch·∫°y ƒë·ªôc l·∫≠p, h·ªó tr·ª£ Docker, d·ªÖ
d√†ng t√≠ch h·ª£p v√†o ·ª©ng d·ª•ng .NET Framework 4.8 ho·∫∑c b·∫•t k·ª≥ h·ªá th·ªëng backend n√†o.

---

## üöÄ M·ª•c ti√™u

- T·ª± ƒë·ªông nh·∫≠n di·ªán v√† tr√≠ch xu·∫•t th√¥ng tin MRZ t·ª´ ·∫£nh h·ªô chi·∫øu ho·∫∑c file PDF.
- H·ªó tr·ª£ ·∫£nh ch·ª•p k√©m ch·∫•t l∆∞·ª£ng.
- C√≥ th·ªÉ t√≠ch h·ª£p v√†o h·ªá th·ªëng qu·∫£n l√Ω ng∆∞·ªùi d√πng, nh·∫≠p c·∫£nh, CRM...
- API d·ªÖ m·ªü r·ªông (auth, logging, tracking...)

---

## üß† C√¥ng ngh·ªá s·ª≠ d·ª•ng

| C√¥ng ngh·ªá              | M√¥ t·∫£                                                                                                         |
|------------------------|---------------------------------------------------------------------------------------------------------------|
| Python 3.10            | Ng√¥n ng·ªØ ch√≠nh                                                                                                |
| FastAPI                | X√¢y d·ª±ng REST API                                                                                             |
| PaddleOCR              | OCR ch√≠nh x√°c cao                                                                                             |
| YOLOv8 (Ultralytics)   | Nh·∫≠n di·ªán v√πng MRZ                                                                                            |
| OpenCV                 | X·ª≠ l√Ω ·∫£nh                                                                                                     |
| pdf2image / PyMuPDF    | X·ª≠ l√Ω PDF                                                                                                     |
| Docker                 | ƒê√≥ng g√≥i v√† tri·ªÉn khai API                                                                                    |
| pytest                 | Ki·ªÉm th·ª≠ t·ª± ƒë·ªông                                                                                              |
| PyTorch                | (GPU h·ªó tr·ª£ CUDA 11.8)                                                                                        |
| Albumentations         | Th∆∞ vi·ªán tƒÉng c∆∞·ªùng d·ªØ li·ªáu m·∫°nh m·∫Ω, h·ªó tr·ª£ c√°c k·ªπ thu·∫≠t nh∆∞ xoay, l√†m m·ªù, thay ƒë·ªïi ƒë·ªô s√°ng, th√™m nhi·ªÖu, v.v. |
| imgaug                 | (t√πy ch·ªçn): Th∆∞ vi·ªán tƒÉng c∆∞·ªùng d·ªØ li·ªáu linh ho·∫°t, h·ªó tr·ª£ nhi·ªÅu ph√©p bi·∫øn ƒë·ªïi ·∫£nh.                            |
| Pillow                 | X·ª≠ l√Ω ·∫£nh c∆° b·∫£n                                                                                              |
| opencv-python-headless | X·ª≠ l√Ω ·∫£nh kh√¥ng c·∫ßn GUI, X·ª≠ l√Ω ·∫£nh (xoay, ch·ªânh s·ª≠a)                                                          |
| scikit-image           | X·ª≠ l√Ω ·∫£nh n√¢ng cao                                                                                            |
| scikit-learn           | X·ª≠ l√Ω ·∫£nh n√¢ng cao                                                                                            |
| numpy                  | X·ª≠ l√Ω d·ªØ li·ªáu                                                                                                 |
| pandas                 | X·ª≠ l√Ω d·ªØ li·ªáu                                                                                                 |
| matplotlib             | Tr·ª±c quan h√≥a d·ªØ li·ªáu                                                                                         |
| torch                  | Th∆∞ vi·ªán h·ªçc s√¢u                                                                                              |
| torchvision            | Th∆∞ vi·ªán h·ªçc s√¢u, H·ªó tr·ª£ x·ª≠ l√Ω ·∫£nh cho PyTorch                                                                |
| tqdm                   | Hi·ªÉn th·ªã ti·∫øn tr√¨nh trong terminal                                                                            |
| faker                  | T·∫°o d·ªØ li·ªáu gi·∫£ cho test, T·∫°o d·ªØ li·ªáu ng·∫´u nhi√™n (t√™n, ng√†y sinh, v.v.)                                       |
| regex                  | X·ª≠ l√Ω chu·ªói, t√¨m ki·∫øm v√† thay th·∫ø chu·ªói theo m·∫´u                                                              |

---

## üîÑ Flow x·ª≠ l√Ω

```text
main.py
  ‚îî‚îÄ‚îÄ FastAPI kh·ªüi ch·∫°y app
      ‚îî‚îÄ‚îÄ /api/extract-passport (endpoints.py)
            ‚îî‚îÄ‚îÄ PassportService.process_passport()
                  ‚îî‚îÄ‚îÄ extract_passport_info() t·ª´ core/reader.py
                        ‚îú‚îÄ‚îÄ X·ª≠ l√Ω ·∫£nh/pdf
                        ‚îú‚îÄ‚îÄ Ph√°t hi·ªán MRZ (YOLOv8 ho·∫∑c OCR)
                        ‚îú‚îÄ‚îÄ Tr√≠ch xu·∫•t vƒÉn b·∫£n (PaddleOCR)
                        ‚îî‚îÄ‚îÄ Parse th√¥ng tin MRZ (mrz_parse)
```

## üìÅ C·∫•u tr√∫c th∆∞ m·ª•c

```
easia-green/
‚îú‚îÄ‚îÄ app/                            # ·ª®ng d·ª•ng ch√≠nh
‚îÇ   ‚îú‚îÄ‚îÄ main.py                     # Entry point kh·ªüi ch·∫°y FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ api/                        # ƒê·ªãnh nghƒ©a c√°c route API
‚îÇ   ‚îú‚îÄ‚îÄ core/                       # X·ª≠ l√Ω OCR, MRZ, preprocess...
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mrz_detect.py           # H√†m ch√≠nh ƒëi·ªÅu ph·ªëi to√†n pipeline
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mrz_detect.py           # D√≤ v√πng MRZ b·∫±ng YOLO ho·∫∑c OCR
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mrz_parse.py            # Parse MRZ text th√†nh structured fields
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ preprocess.py           #  x·ª≠ l√Ω ·∫£nh: resize, contrast, l√†m m∆∞·ª£t, v.v.
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pdf_utils.py            # chuy·ªÉn PDF th√†nh ·∫£nh
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py                # (tu·ª≥ ch·ªçn ‚Äì validate ng√†y, logging, helper nh·ªè)
‚îÇ   ‚îú‚îÄ‚îÄ services/                   # X·ª≠ l√Ω nghi·ªáp v·ª• (d√πng core + models)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ passport_services.py    # X·ª≠ l√Ω nghi·ªáp v·ª• passport
‚îÇ   ‚îú‚îÄ‚îÄ models/                     # Trained YOLOv8 models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ yolov8_mrz.pt           # Model YOLOv8 ƒë√£ train
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ paddleocr/             # Model PaddleOCR
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ocr_system/         # Model OCR
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ocr_system.py        # H√†m ch√≠nh g·ªçi OCR
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ocr_system_config.py # C·∫•u h√¨nh cho OCR
‚îÇ   ‚îú‚îÄ‚îÄ test/                       # Unit test
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_mrz_detect.py        # Test d√≤ v√πng MRZ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_mrz_parse.py         # Test parse MRZ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_preprocess.py         # Test x·ª≠ l√Ω ·∫£nh
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_pdf_utils.py          # Test chuy·ªÉn PDF th√†nh ·∫£nh
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_utils.py              # Test c√°c h√†m ti·ªán √≠ch
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_reader.py             # Test tr√≠ch xu·∫•t ·∫£nh sang text
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_passport_services.py  # Test d·ªãch v·ª• passport
‚îÇ   ‚îú‚îÄ‚îÄ utils/                          # Ch·ª©a c√°c h√†m ti·ªán √≠ch d√πng chung
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils_logging.py            # Ti·ªán √≠ch ghi log
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils_valid.py              # Ti·ªán √≠ch validate d·ªØ li·ªáu
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt            # C√°c th∆∞ vi·ªán ph·ª• thu·ªôc
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile                  # Docker h√≥a ·ª©ng d·ª•ng
‚îÇ
‚îú‚îÄ‚îÄ store/                          # L∆∞u d·ªØ li·ªáu test, ·∫£nh input/output
‚îÇ   ‚îú‚îÄ‚îÄ input/
‚îÇ   ‚îî‚îÄ‚îÄ output/
‚îÇ
‚îú‚îÄ‚îÄ notebooks/                      # Jupyter notebook d√πng ƒë·ªÉ th·ª≠ nghi·ªám
‚îÇ   ‚îî‚îÄ‚îÄ demo_passport_reader.ipynb  # Demo c√°ch s·ª≠ d·ª•ng API
‚îÇ
‚îú‚îÄ‚îÄ logs/                           # L∆∞u log h·ªá th·ªëng
‚îÇ   ‚îî‚îÄ‚îÄ log_YYYYMMDD.log            # Log h·ªá th·ªëng
‚îÇ
‚îú‚îÄ‚îÄ train/                          # D√πng ƒë·ªÉ train m√¥ h√¨nh YOLOv8 ri√™ng
‚îÇ   ‚îú‚îÄ‚îÄ datasets/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ train/         # ·∫¢nh hu·∫•n luy·ªán
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ img001.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ val/           # ·∫¢nh validation
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ img099.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ labels/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ train/         # Nh√£n YOLO t∆∞∆°ng ·ª©ng
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ img001.txt
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ val/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ img099.txt
‚îÇ   ‚îú‚îÄ‚îÄ data.yaml                   # C·∫•u h√¨nh cho YOLO
‚îÇ   ‚îî‚îÄ‚îÄ train.py                   # Script hu·∫•n luy·ªán
‚îÇ
‚îú‚îÄ‚îÄ run_tests.py       # Script ch·∫°y to√†n b·ªô test ‚úÖ
‚îÇ
‚îî‚îÄ‚îÄ README.md



```

## üîÅ Lu·ªìng x·ª≠ l√Ω ch√≠nh

```
main.py ‚Üí API endpoint ‚Üí services ‚Üí core (detect, OCR, parse)
```

## ‚úÖ C√°ch ch·∫°y test to√†n b·ªô

```bash
python run_tests.py
```

- Script s·∫Ω ch·∫°y t·∫•t c·∫£ c√°c test trong `app/test/`
- Log k·∫øt qu·∫£ v√† c·∫£nh b√°o n·∫øu thi·∫øu file m·∫´u (`sample_passport.jpg`, `sample_passport.pdf`, ...)

> üì¶ ƒê·∫£m b·∫£o b·∫°n ƒë√£ c√≥ c√°c file m·∫´u test trong th∆∞ m·ª•c `store/input/` ƒë·ªÉ tr√°nh b·ªã skip.

---

---

## ‚öôÔ∏è C√°ch ch·∫°y local

```bash
cd app
python -m venv .venv
type .venv/Scripts/activate     # Windows
source .venv/bin/activate       # Unix
pip install -r requirements.txt
python main.py
```

> API s·∫Ω ch·∫°y t·∫°i `http://localhost:8000/api/extract-passport`

---

## üê≥ Ch·∫°y v·ªõi Docker

```bash
cd app
docker build -t easia-green-api .
docker run -p 8000:8000 easia-green-api
```

---

## üß™ G·ªçi th·ª≠ API

```bash
curl -X POST http://localhost:8000/api/extract-passport \
  -F "file=@store/input/passport.jpg"
```

K·∫øt qu·∫£ tr·∫£ v·ªÅ d·∫°ng JSON:

```json
{
  "passport_number": "B1234567",
  "surname": "NGUYEN",
  "given_names": "VAN A",
  "nationality": "VNM",
  "date_of_birth": "1990-01-01",
  "expiration_date": "2030-01-01",
  "gender": "M"
}
```

---

## Annotate d·ªØ li·ªáu

B·∫°n c·∫ßn ƒë√°nh d·∫•u v√πng MRZ trong m·ªói ·∫£nh.

### C√¥ng c·ª• ƒë·ªÅ xu·∫•t:

- [‚úÖ Roboflow](https://roboflow.com) ‚Äì online, tr·ª±c quan
- [‚úÖ LabelImg](https://github.com/tzutalin/labelImg) ‚Äì local, open-source
- [‚úÖ Label Studio](https://labelstud.io) ‚Äì t√πy bi·∫øn m·∫°nh

### Format file `.txt` (YOLO format):

M·ªói file `.txt` c√πng t√™n v·ªõi ·∫£nh `.jpg`, ch·ª©a 1 d√≤ng: 0 0.5 0.9 0.8 0.1

> `class_id x_center y_center width height` (to√†n b·ªô gi√° tr·ªã l√† t·ª∑ l·ªá 0-1)

## üß† Hu·∫•n luy·ªán l·∫°i YOLOv8 cho MRZ

1. Chu·∫©n b·ªã d·ªØ li·ªáu:

```
train/datasets/mrz/
‚îú‚îÄ‚îÄ images/train, val
‚îú‚îÄ‚îÄ labels/train, val    # file .txt YOLO format
```

- ch√∫ th√≠ch
  - T·∫°o th∆∞ m·ª•c `datasets/mrz/` trong th∆∞ m·ª•c `train/`.
  - `images/train/` v√† `images/val/` ch·ª©a ·∫£nh hu·∫•n luy·ªán v√† validation.
  - `labels/train/` v√† `labels/val/` ch·ª©a nh√£n t∆∞∆°ng ·ª©ng v·ªõi ·∫£nh.
  - M·ªói ·∫£nh c√≥ 1 file nh√£n `.txt` c√πng t√™n, ch·ª©a t·ªça ƒë·ªô v√πng MRZ.
  - T·∫°o 2 th∆∞ m·ª•c `train` v√† `val` trong `datasets/mrz/images/` v√† `datasets/mrz/labels/`.
  - Chia d·ªØ li·ªáu th√†nh 2 ph·∫ßn: 80% cho train v√† 20% cho val.
  - T·∫°o file `mrz.yaml` trong th∆∞ m·ª•c `train/` ƒë·ªÉ ƒë·ªãnh nghƒ©a c·∫•u h√¨nh cho YOLOv8.
  - Ch·∫°y script hu·∫•n luy·ªán YOLOv8.
  - Sau khi hu·∫•n luy·ªán xong, copy file m√¥ h√¨nh t·ªët nh·∫•t v√†o th∆∞ m·ª•c `app/models/`.
  - Format file `.txt` (YOLO format):

M·ªói file `.txt` c√πng t√™n v·ªõi ·∫£nh `.jpg`, ch·ª©a 1 d√≤ng: 0 0.5 0.9 0.8 0.1

> `class_id x_center y_center width height` (to√†n b·ªô gi√° tr·ªã l√† t·ª∑ l·ªá 0-1)

2. File `mrz.yaml`:

```yaml
path: ./datasets/mrz
train: images/train
val: images/val
nc: 1
names: [ "mrz" ]
```

3. Hu·∫•n luy·ªán m√¥ h√¨nh

```bash
cd train
python train.py
```

- Ho·∫∑c d√πng tr·ª±c ti·∫øp t·ª´ YOLO CLI:

```bash
cd train
yolo task=detect mode=train model=yolov8n.pt data=mrz.yaml epochs=100 imgsz=640

- hoac
yolo task=detect mode=train \
  model=yolov8n.pt \
  data=mrz.yaml \
  epochs=100 \
  imgsz=640
```

> N·∫øu m√°y m·∫°nh h∆°n, b·∫°n c√≥ th·ªÉ d√πng yolov8s.pt ho·∫∑c yolov8m.pt thay v√¨ n.

4. K·∫øt qu·∫£ sau hu·∫•n luy·ªán.
   4.1 YOLO s·∫Ω t·∫°o th∆∞ m·ª•c:

```bash
runs/detect/train/
‚îú‚îÄ‚îÄ weights/
‚îÇ   ‚îî‚îÄ‚îÄ best.pt    ‚úÖ <-- file m√¥ h√¨nh t·ªët nh·∫•t
```

4.2 Copy file .pt v·ªÅ app:

```bash
cp runs/detect/train/weights/best.pt ../app/models/yolov8_mrz.pt
```

4.3 Sau hu·∫•n luy·ªán, copy model t·ªët nh·∫•t v√†o app:

```bash
cp train/runs/detect/train/weights/best.pt app/models/yolov8_mrz.pt
```

5. Ki·ªÉm tra l·∫°i pipeline

- Sau khi copy m√¥ h√¨nh xong, ch·∫°y API ho·∫∑c test l·∫°i b·∫±ng notebook:

---

## üìå Ghi ch√∫

- PaddleOCR h·ªó tr·ª£ t·ªët c·∫£ ·∫£nh scan, ·∫£nh b·ªã nghi√™ng ho·∫∑c m·ªù nh·∫π.
- MRZ ƒë∆∞·ª£c detect b·∫±ng PaddleOCR ho·∫∑c YOLO t√πy v√†o c·∫•u h√¨nh.
- M·ªçi x·ª≠ l√Ω ·∫£nh, detect, tr√≠ch xu·∫•t ƒë·ªÅu c√≥ th·ªÉ tinh ch·ªânh.
- C√°c log x·ª≠ l√Ω ƒë∆∞·ª£c ghi t·ª± ƒë·ªông v√†o `logs/log_YYYYMMDD.log`
- D·ªãch v·ª• nghi·ªáp v·ª• ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü t·∫ßng `services/` t√°ch bi·ªát v·ªõi `core/`
- C√≥ th·ªÉ th√™m auth middleware v√†o `api/endpoints.py`.

---

## ‚úÖ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:

Build v√† ch·∫°y container:
docker compose up --build

Truy c·∫≠p API t·∫°i: http://localhost:8000
Swagger UI:         http://localhost:8000/docs
Ki·ªÉm tra log:       docker logs -f easia-green-api
Ki·ªÉm tra container: docker ps

## ‚ú® TODO m·ªü r·ªông (tu·ª≥ ch·ªçn)

- [ ] Vi·∫øt file `endpoints.py` x·ª≠ l√Ω API `/extract-passport`
- [ ] Vi·∫øt `reader.py` ƒë·ªÉ ƒëi·ªÅu ph·ªëi pipeline (load ·∫£nh, detect MRZ, OCR, parse)
- [ ] Vi·∫øt `mrz_detect.py`: PaddleOCR ho·∫∑c YOLO detect v√πng MRZ
- [ ] Vi·∫øt `mrz_parse.py`: t√°ch d√≤ng MRZ v√† ph√¢n t√≠ch th√†nh th√¥ng tin structured
- [ ] X·ª≠ l√Ω ·∫£nh t·ª´ PDF trong `pdf_utils.py`
- [ ] Vi·∫øt `Dockerfile` cho app
- [ ] Vi·∫øt test m·∫´u cho pipeline ch√≠nh
- [ ] T·ªëi ∆∞u h√≥a pipeline x·ª≠ l√Ω ·∫£nh m·ªù/nghi√™ng
- [ ] Th√™m ki·ªÉm th·ª≠ ƒë·∫ßu v√†o (validate file, ƒë·ªãnh d·∫°ng ·∫£nh, x·ª≠ l√Ω l·ªói OCR)
- [ ] Vi·∫øt th√™m unit test cho `services/passport_service.py`
- [ ] X·ª≠ l√Ω b·∫•t th∆∞·ªùng trong MRZ, fallback OCR nhi·ªÅu v√πng
- [ ] T√≠ch h·ª£p ph·∫ßn x√°c th·ª±c (auth) ho·∫∑c ph√¢n quy·ªÅn
- [ ] T√°ch ·∫£nh ch√¢n dung v√† crop v√πng ch·ªØ k√Ω
- [ ] T·ª± ƒë·ªông log h·ªá th·ªëng v√† g·ª≠i l·ªói ra email/Slack
- [ ] T·ª± ƒë·ªông h√≥a ƒë√°nh nh√£n ·∫£nh MRZ
- [ ] T·ªëi ∆∞u inference multi-GPU
- [ ] T√≠ch h·ª£p x√°c th·ª±c s·ªë h·ªô chi·∫øu b·∫±ng checksum
- [ ] Export model sang ONNX ƒë·ªÉ deploy cross-platform
-

---


üöÄ C√°ch s·ª≠ d·ª•ng
1. Ch·∫°y m·∫∑c ƒë·ªãnh:
   ```bash
   python train/train.py
   ```
2. Ch·∫°y v·ªõi th√¥ng s·ªë t√πy ch·ªânh:
   ```bash
   python train/train.py --model yolov8s.pt --epochs 50 --imgsz 640 --batch 8 --lr 0.0005 --run_name pas
   ```





# Auth

üöÄ *by Easia-Project teams!*
**baauf**

